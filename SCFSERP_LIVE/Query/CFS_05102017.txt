
TABLES
------

1. STUFFINGMASTER
   --------------

STFBILLEDTO	smallint	Unchecked
STFBILLREFID	int	Unchecked
STFBILLREFNAME	varchar(100)	Checked


VIEWS
-----

1.

UPDATE STUFFINGMASTER SET STFBILLEDTO = 0, STFBILLREFID = CHAID, STFBILLREFNAME = STFMNAME



PROCEDURE
---------


1.


USE [CFS]
GO
/****** Object:  StoredProcedure [dbo].[pr_Export_Stuffing_COrder_No_Assgn]    Script Date: 05/10/2017 18:24:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[pr_Export_Stuffing_COrder_No_Assgn]  /* CHANGE */
		@PCHAId int, @PKUSRID VARCHAR(100)
 
AS BEGIN
    --Wrap filter term with % to search for values that contain @FilterTerm

    DECLARE @TableMaster TABLE
    ( 
	   SBMID  INT,
	   SBDID INT ,
	   SBMDNO VARCHAR(100),
	   SBDNOP NUMERIC(18,2),
	   BNOP NUMERIC(18,2)
    )


DECLARE @LCHAId int, @LKUSRID VARCHAR(100)
set @LCHAId =@PCHAId
set @LKUSRID =@PKUSRID

set nocount on



/*
INSERT INTO @TableMaster(SBMID, SBDID, SBMDNO, SBDNOP, BNOP)
SELECT  dbo.SHIPPINGBILLDETAIL.SBMID, dbo.SHIPPINGBILLDETAIL.SBDID, 
                      LTRIM(dbo.SHIPPINGBILLMASTER.SBMDNO) + '(' + dbo.VW_YEAR_DETAIL_CBX_ASSGN.YRDESC + ')' AS SBMDNO,  
                      dbo.SHIPPINGBILLDETAIL.SBDNOP, dbo.SHIPPINGBILLDETAIL.SBDNOP - ISNULL(dbo.VW_STUFFING_SBILLNO_REFNO_CBX_ASSGN_01.STFDNOP, 0) 
                      - ISNULL(dbo.VW_STUFFING_SBILLNO_REFNO_CBX_ASSGN_02.TRANDNOP, 0) AS BNOP
FROM         dbo.SHIPPINGBILLDETAIL INNER JOIN
                      dbo.SHIPPINGBILLMASTER ON dbo.SHIPPINGBILLDETAIL.SBMID = dbo.SHIPPINGBILLMASTER.SBMID INNER JOIN
                      dbo.VW_YEAR_DETAIL_CBX_ASSGN ON dbo.SHIPPINGBILLMASTER.COMPYID = dbo.VW_YEAR_DETAIL_CBX_ASSGN.COMPYID INNER JOIN
                      dbo.EXPORTSHIPPINGBILLMASTER ON dbo.SHIPPINGBILLDETAIL.ESBMID = dbo.EXPORTSHIPPINGBILLMASTER.ESBMID LEFT OUTER JOIN
                      dbo.VW_STUFFING_SBILLNO_REFNO_CBX_ASSGN_02 ON 
                      dbo.SHIPPINGBILLDETAIL.SBDID = dbo.VW_STUFFING_SBILLNO_REFNO_CBX_ASSGN_02.SBDID LEFT OUTER JOIN
                      dbo.VW_STUFFING_SBILLNO_REFNO_CBX_ASSGN_01 ON dbo.SHIPPINGBILLDETAIL.SBDID = dbo.VW_STUFFING_SBILLNO_REFNO_CBX_ASSGN_01.SBDID
WHERE   (dbo.SHIPPINGBILLMASTER.CHAID = @LCHAID) AND  (dbo.SHIPPINGBILLDETAIL.SBDNOP - ISNULL(dbo.VW_STUFFING_SBILLNO_REFNO_CBX_ASSGN_01.STFDNOP, 0) 
                      - ISNULL(dbo.VW_STUFFING_SBILLNO_REFNO_CBX_ASSGN_02.TRANDNOP, 0) > 0)
GROUP BY dbo.SHIPPINGBILLDETAIL.SBMID, dbo.SHIPPINGBILLDETAIL.SBDID, LTRIM(dbo.SHIPPINGBILLMASTER.SBMDNO) 
                      + '(' + dbo.VW_YEAR_DETAIL_CBX_ASSGN.YRDESC + ')', dbo.SHIPPINGBILLDETAIL.SBDNOP,
                      dbo.SHIPPINGBILLDETAIL.SBDNOP - ISNULL(dbo.VW_STUFFING_SBILLNO_REFNO_CBX_ASSGN_01.STFDNOP, 0) 
                      - ISNULL(dbo.VW_STUFFING_SBILLNO_REFNO_CBX_ASSGN_02.TRANDNOP, 0)
ORDER BY dbo.SHIPPINGBILLDETAIL.SBDID

INSERT INTO @TableMaster(SBMID, SBDID, SBMDNO, SBDNOP, BNOP)

SELECT  SBMID, SBDID, '-', 0, SUM(NOP) * -1 AS SBDNOP
FROM         dbo.TMP_STUFFING_SBDID WHERE KUSRID = @LKUSRID
GROUP BY SBMID, SBDID
ORDER BY SBDID
               
                      
    SELECT SBMID,MAX(SBMDNO) AS SBMDNO, SUM(SBDNOP) AS SBDNOP, SUM(BNOP) AS BNOP
    FROM @TableMaster GROUP BY SBMID  HAVING SUM(BNOP) > 0 order by  SBMID 


*/

INSERT INTO @TableMaster(SBMID, SBDID, SBMDNO, SBDNOP, BNOP)
SELECT        TOP (100) PERCENT dbo.SHIPPINGBILLDETAIL.SBMID, dbo.SHIPPINGBILLDETAIL.SBDID, LTRIM(dbo.SHIPPINGBILLMASTER.SBMDNO) 
                         + '(' + dbo.VW_YEAR_DETAIL_CBX_ASSGN.YRDESC + ')' AS SBMDNO, dbo.SHIPPINGBILLDETAIL.SBDNOP, 0
FROM            dbo.SHIPPINGBILLDETAIL INNER JOIN
                         dbo.SHIPPINGBILLMASTER ON dbo.SHIPPINGBILLDETAIL.SBMID = dbo.SHIPPINGBILLMASTER.SBMID INNER JOIN
                         dbo.VW_YEAR_DETAIL_CBX_ASSGN ON dbo.SHIPPINGBILLMASTER.COMPYID = dbo.VW_YEAR_DETAIL_CBX_ASSGN.COMPYID INNER JOIN
                         dbo.EXPORTSHIPPINGBILLMASTER ON dbo.SHIPPINGBILLDETAIL.ESBMID = dbo.EXPORTSHIPPINGBILLMASTER.ESBMID
WHERE        (dbo.SHIPPINGBILLMASTER.CHAID = @LCHAID)
GROUP BY dbo.SHIPPINGBILLDETAIL.SBMID, dbo.SHIPPINGBILLDETAIL.SBDID, LTRIM(dbo.SHIPPINGBILLMASTER.SBMDNO) 
                         + '(' + dbo.VW_YEAR_DETAIL_CBX_ASSGN.YRDESC + ')', dbo.SHIPPINGBILLDETAIL.SBDNOP
ORDER BY dbo.SHIPPINGBILLDETAIL.SBDID


--balance
INSERT INTO @TableMaster(SBMID, SBDID, SBMDNO, SBDNOP, BNOP)
SELECT   dbo.SHIPPINGBILLDETAIL.SBMID, dbo.STUFFINGPRODUCTDETAIL.SBDID, LTRIM(dbo.SHIPPINGBILLMASTER.SBMDNO) 
                         + '(' + dbo.VW_YEAR_DETAIL_CBX_ASSGN.YRDESC + ')' , 0, SUM(dbo.STUFFINGPRODUCTDETAIL.STFDNOP) AS STFDNOP
FROM            dbo.STUFFINGPRODUCTDETAIL INNER JOIN
                         dbo.STUFFINGDETAIL ON dbo.STUFFINGPRODUCTDETAIL.STFDID = dbo.STUFFINGDETAIL.STFDID INNER JOIN
                         dbo.SHIPPINGBILLDETAIL ON dbo.STUFFINGPRODUCTDETAIL.SBDID = dbo.SHIPPINGBILLDETAIL.SBDID INNER JOIN
                         dbo.SHIPPINGBILLMASTER ON dbo.SHIPPINGBILLDETAIL.SBMID = dbo.SHIPPINGBILLMASTER.SBMID INNER JOIN
                         dbo.VW_YEAR_DETAIL_CBX_ASSGN ON dbo.SHIPPINGBILLMASTER.COMPYID = dbo.VW_YEAR_DETAIL_CBX_ASSGN.COMPYID
GROUP BY dbo.STUFFINGPRODUCTDETAIL.SBDID, dbo.SHIPPINGBILLDETAIL.SBMID, LTRIM(dbo.SHIPPINGBILLMASTER.SBMDNO) 
                         + '(' + dbo.VW_YEAR_DETAIL_CBX_ASSGN.YRDESC + ')'
ORDER BY dbo.STUFFINGPRODUCTDETAIL.SBDID



INSERT INTO @TableMaster(SBMID, SBDID, SBMDNO, SBDNOP, BNOP)

SELECT  SBMID, SBDID, '-', 0, SUM(NOP) * 1 AS SBDNOP
FROM         dbo.TMP_STUFFING_SBDID WHERE KUSRID = @LKUSRID
GROUP BY SBMID, SBDID
ORDER BY SBDID
               
                      
    SELECT SBMID,MAX(SBMDNO) AS SBMDNO, SUM(SBDNOP) AS SBDNOP, SUM(SBDNOP - BNOP) AS BNOP
    FROM @TableMaster GROUP BY SBMID  HAVING SUM(SBDNOP - BNOP) > 0 order by  SBMID 
    
    return    
    
END



2.


USE [CFS]
GO
/****** Object:  StoredProcedure [dbo].[PR_STUFFINGDETAIL_FLX_ASSGN]    Script Date: 05/10/2017 19:09:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[PR_STUFFINGDETAIL_FLX_ASSGN] @PSTFMID INT as 


--, @PCHAID INT AS

/*
SELECT     TOP (100) PERCENT dbo.SHIPPINGBILLDETAIL.SBMID, dbo.SHIPPINGBILLDETAIL.SBDID, dbo.SHIPPINGBILLMASTER.CHAID, 
                      dbo.SHIPPINGBILLDETAIL.SBDNO, dbo.GATEINDETAIL.GIDID, dbo.SHIPPINGBILLDETAIL.SBDDNO, dbo.SHIPPINGBILLDETAIL.SBDDATE, 
                      dbo.SHIPPINGBILLDETAIL.PRDTDESC, dbo.SHIPPINGBILLDETAIL.SBDNOP, dbo.EXPORTSHIPPINGBILLMASTER.ESBMDNO, 
                      dbo.EXPORTSHIPPINGBILLMASTER.ESBMDATE, 
                      dbo.SHIPPINGBILLDETAIL.SBDNOP - ISNULL(dbo.VW_STUFFING_SBILLNO_REFNO_CBX_ASSGN_01.STFDNOP, 0) AS BNOP, 
                      ISNULL(dbo.STUFFINGDETAIL.STFMID, 0) AS STFMID, ISNULL(dbo.STUFFINGPRODUCTDETAIL.STFPID, 0) AS STFPID, 
                      ISNULL(dbo.STUFFINGDETAIL.STFDID, 0) AS STFDID, ISNULL(dbo.STUFFINGPRODUCTDETAIL.STFDNOP, 0) AS STFDNOP, 
                      ISNULL(dbo.STUFFINGPRODUCTDETAIL.STFDQTY, 0) AS STFDQTY, dbo.GATEINDETAIL.CONTNRNO, dbo.CONTAINERSIZEMASTER.CONTNRSDESC, 
                      ISNULL(dbo.STUFFINGDETAIL.STFTYPE, 0) AS STFTYPE, dbo.SHIPPINGBILLMASTER.SBMDATE, LTRIM(dbo.SHIPPINGBILLMASTER.SBMDNO) 
                      + '(' + dbo.VW_YEAR_DETAIL_CBX_ASSGN.YRDESC + ')' AS SBMDNO, dbo.SHIPPINGBILLMASTER.CHANAME, dbo.STUFFINGMASTER.STFMNO, 
                      dbo.STUFFINGMASTER.STFMDNO, dbo.STUFFINGMASTER.STFMDATE, dbo.STUFFINGMASTER.STFMTIME, dbo.STUFFINGMASTER.LCATEID, 
                      dbo.STUFFINGMASTER.LCATENAME
FROM         dbo.STUFFINGPRODUCTDETAIL LEFT OUTER JOIN
                      dbo.STUFFINGMASTER INNER JOIN
                      dbo.STUFFINGDETAIL ON dbo.STUFFINGMASTER.STFMID = dbo.STUFFINGDETAIL.STFMID LEFT OUTER JOIN
                      dbo.CONTAINERSIZEMASTER RIGHT OUTER JOIN
                      dbo.GATEINDETAIL ON dbo.CONTAINERSIZEMASTER.CONTNRSID = dbo.GATEINDETAIL.CONTNRSID ON 
                      dbo.STUFFINGDETAIL.GIDID = dbo.GATEINDETAIL.GIDID ON 
                      dbo.STUFFINGPRODUCTDETAIL.STFDID = dbo.STUFFINGDETAIL.STFDID RIGHT OUTER JOIN
                      dbo.VW_YEAR_DETAIL_CBX_ASSGN INNER JOIN
                      dbo.SHIPPINGBILLDETAIL INNER JOIN
                      dbo.SHIPPINGBILLMASTER ON dbo.SHIPPINGBILLDETAIL.SBMID = dbo.SHIPPINGBILLMASTER.SBMID ON 
                      dbo.VW_YEAR_DETAIL_CBX_ASSGN.COMPYID = dbo.SHIPPINGBILLMASTER.COMPYID ON 
                      dbo.STUFFINGPRODUCTDETAIL.SBDID = dbo.SHIPPINGBILLDETAIL.SBDID LEFT OUTER JOIN
                      dbo.EXPORTSHIPPINGBILLMASTER ON dbo.SHIPPINGBILLDETAIL.ESBMID = dbo.EXPORTSHIPPINGBILLMASTER.ESBMID LEFT OUTER JOIN
                      dbo.VW_STUFFING_SBILLNO_REFNO_CBX_ASSGN_01 ON 
                      dbo.SHIPPINGBILLDETAIL.SBDID = dbo.VW_STUFFING_SBILLNO_REFNO_CBX_ASSGN_01.SBDID
GROUP BY dbo.SHIPPINGBILLDETAIL.SBMID, dbo.SHIPPINGBILLDETAIL.SBDDNO, dbo.SHIPPINGBILLDETAIL.SBDNO, dbo.SHIPPINGBILLDETAIL.SBDID, 
                      dbo.SHIPPINGBILLDETAIL.SBDDATE, dbo.SHIPPINGBILLDETAIL.PRDTDESC, dbo.SHIPPINGBILLDETAIL.SBDNOP, 
                      dbo.SHIPPINGBILLDETAIL.SBDNOP - ISNULL(dbo.VW_STUFFING_SBILLNO_REFNO_CBX_ASSGN_01.STFDNOP, 0), 
                      dbo.EXPORTSHIPPINGBILLMASTER.ESBMDNO, dbo.EXPORTSHIPPINGBILLMASTER.ESBMDATE, ISNULL(dbo.STUFFINGDETAIL.STFMID, 0), 
                      ISNULL(dbo.STUFFINGPRODUCTDETAIL.STFPID, 0), ISNULL(dbo.STUFFINGDETAIL.STFDID, 0), dbo.SHIPPINGBILLMASTER.CHAID, 
                      ISNULL(dbo.STUFFINGPRODUCTDETAIL.STFDNOP, 0), ISNULL(dbo.STUFFINGPRODUCTDETAIL.STFDQTY, 0), dbo.GATEINDETAIL.CONTNRNO, 
                      dbo.CONTAINERSIZEMASTER.CONTNRSDESC, ISNULL(dbo.STUFFINGDETAIL.STFTYPE, 0), dbo.SHIPPINGBILLMASTER.SBMDATE, 
                      LTRIM(dbo.SHIPPINGBILLMASTER.SBMDNO) + '(' + dbo.VW_YEAR_DETAIL_CBX_ASSGN.YRDESC + ')', dbo.GATEINDETAIL.GIDID, 
                      dbo.SHIPPINGBILLMASTER.CHANAME, dbo.STUFFINGMASTER.STFMNO, dbo.STUFFINGMASTER.STFMDNO, dbo.STUFFINGMASTER.STFMDATE, 
                      dbo.STUFFINGMASTER.STFMTIME, dbo.STUFFINGMASTER.LCATEID, dbo.STUFFINGMASTER.LCATENAME
HAVING      (ISNULL(dbo.STUFFINGDETAIL.STFMID, 0) = @PSTFMID)
ORDER BY dbo.SHIPPINGBILLDETAIL.SBDNO
*/
SELECT        TOP (100) PERCENT dbo.SHIPPINGBILLDETAIL.SBMID, dbo.SHIPPINGBILLDETAIL.SBDID, dbo.SHIPPINGBILLMASTER.CHAID, dbo.SHIPPINGBILLDETAIL.SBDNO, 
                         dbo.GATEINDETAIL.GIDID, dbo.SHIPPINGBILLDETAIL.SBDDNO, dbo.SHIPPINGBILLDETAIL.SBDDATE, dbo.SHIPPINGBILLDETAIL.PRDTDESC, 
                         dbo.SHIPPINGBILLDETAIL.SBDNOP, dbo.EXPORTSHIPPINGBILLMASTER.ESBMDNO, dbo.EXPORTSHIPPINGBILLMASTER.ESBMDATE, 
                         dbo.SHIPPINGBILLDETAIL.SBDNOP - ISNULL(dbo.VW_STUFFING_SBILLNO_REFNO_CBX_ASSGN_01.STFDNOP, 0) AS BNOP, dbo.STUFFINGDETAIL.STFMID, 
                         dbo.STUFFINGPRODUCTDETAIL.STFPID, dbo.STUFFINGDETAIL.STFDID, dbo.STUFFINGPRODUCTDETAIL.STFDNOP, dbo.STUFFINGPRODUCTDETAIL.STFDQTY, 
                         dbo.GATEINDETAIL.CONTNRNO, dbo.CONTAINERSIZEMASTER.CONTNRSDESC, dbo.STUFFINGDETAIL.STFTYPE, dbo.SHIPPINGBILLMASTER.SBMDATE, 
                         LTRIM(dbo.SHIPPINGBILLMASTER.SBMDNO) + '(' + dbo.VW_YEAR_DETAIL_CBX_ASSGN.YRDESC + ')' AS SBMDNO, dbo.SHIPPINGBILLMASTER.CHANAME, 
                         dbo.STUFFINGMASTER.STFMNO, dbo.STUFFINGMASTER.STFMDNO, dbo.STUFFINGMASTER.STFMDATE, dbo.STUFFINGMASTER.STFMTIME, 
                         dbo.STUFFINGMASTER.LCATEID, dbo.STUFFINGMASTER.LCATENAME
FROM            dbo.CONTAINERSIZEMASTER RIGHT OUTER JOIN
                         dbo.STUFFINGPRODUCTDETAIL INNER JOIN
                         dbo.STUFFINGMASTER INNER JOIN
                         dbo.STUFFINGDETAIL ON dbo.STUFFINGMASTER.STFMID = dbo.STUFFINGDETAIL.STFMID INNER JOIN
                         dbo.GATEINDETAIL ON dbo.STUFFINGDETAIL.GIDID = dbo.GATEINDETAIL.GIDID ON dbo.STUFFINGPRODUCTDETAIL.STFDID = dbo.STUFFINGDETAIL.STFDID ON 
                         dbo.CONTAINERSIZEMASTER.CONTNRSID = dbo.GATEINDETAIL.CONTNRSID RIGHT OUTER JOIN
                         dbo.VW_YEAR_DETAIL_CBX_ASSGN INNER JOIN
                         dbo.SHIPPINGBILLDETAIL INNER JOIN
                         dbo.SHIPPINGBILLMASTER ON dbo.SHIPPINGBILLDETAIL.SBMID = dbo.SHIPPINGBILLMASTER.SBMID ON 
                         dbo.VW_YEAR_DETAIL_CBX_ASSGN.COMPYID = dbo.SHIPPINGBILLMASTER.COMPYID ON 
                         dbo.STUFFINGPRODUCTDETAIL.SBDID = dbo.SHIPPINGBILLDETAIL.SBDID LEFT OUTER JOIN
                         dbo.EXPORTSHIPPINGBILLMASTER ON dbo.SHIPPINGBILLDETAIL.ESBMID = dbo.EXPORTSHIPPINGBILLMASTER.ESBMID LEFT OUTER JOIN
                         dbo.VW_STUFFING_SBILLNO_REFNO_CBX_ASSGN_01 ON 
                         dbo.SHIPPINGBILLDETAIL.SBDID = dbo.VW_STUFFING_SBILLNO_REFNO_CBX_ASSGN_01.SBDID
GROUP BY dbo.SHIPPINGBILLDETAIL.SBMID, dbo.SHIPPINGBILLDETAIL.SBDDNO, dbo.SHIPPINGBILLDETAIL.SBDNO, dbo.SHIPPINGBILLDETAIL.SBDID, 
                         dbo.SHIPPINGBILLDETAIL.SBDDATE, dbo.SHIPPINGBILLDETAIL.PRDTDESC, dbo.SHIPPINGBILLDETAIL.SBDNOP, 
                         dbo.SHIPPINGBILLDETAIL.SBDNOP - ISNULL(dbo.VW_STUFFING_SBILLNO_REFNO_CBX_ASSGN_01.STFDNOP, 0), dbo.EXPORTSHIPPINGBILLMASTER.ESBMDNO, 
                         dbo.EXPORTSHIPPINGBILLMASTER.ESBMDATE, dbo.STUFFINGDETAIL.STFMID, dbo.STUFFINGPRODUCTDETAIL.STFPID, dbo.STUFFINGDETAIL.STFDID, 
                         dbo.SHIPPINGBILLMASTER.CHAID, dbo.STUFFINGPRODUCTDETAIL.STFDNOP, dbo.STUFFINGPRODUCTDETAIL.STFDQTY, dbo.GATEINDETAIL.CONTNRNO, 
                         dbo.CONTAINERSIZEMASTER.CONTNRSDESC, dbo.STUFFINGDETAIL.STFTYPE, dbo.SHIPPINGBILLMASTER.SBMDATE, 
                         LTRIM(dbo.SHIPPINGBILLMASTER.SBMDNO) + '(' + dbo.VW_YEAR_DETAIL_CBX_ASSGN.YRDESC + ')', dbo.GATEINDETAIL.GIDID, 
                         dbo.SHIPPINGBILLMASTER.CHANAME, dbo.STUFFINGMASTER.STFMNO, dbo.STUFFINGMASTER.STFMDNO, dbo.STUFFINGMASTER.STFMDATE, 
                         dbo.STUFFINGMASTER.STFMTIME, dbo.STUFFINGMASTER.LCATEID, dbo.STUFFINGMASTER.LCATENAME
HAVING        (dbo.STUFFINGDETAIL.STFMID = @PSTFMID)
ORDER BY dbo.SHIPPINGBILLDETAIL.SBDNO

